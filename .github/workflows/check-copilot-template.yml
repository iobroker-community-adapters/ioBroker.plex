# GitHub Action Template: Automated Version Check and Update for ioBroker Copilot Instructions
# Version: 0.4.0
# 
# This action automatically checks for template updates and creates issues when updates are available
# Copy this to your repository as .github/workflows/check-copilot-template.yml

name: Check ioBroker Copilot Template Version

on:
  schedule:
    - cron: '23 3 * * 0'  # Weekly check optimized for off-peak hours (3:23 AM UTC Sunday)
  workflow_dispatch:  # Allow manual triggering

jobs:
  check-template:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Dynamic template version check
        id: version-check
        run: |
          echo "🔍 Starting dynamic ioBroker Copilot template version check..."
          
          # Get current version from local copilot instructions
          if [ -f ".github/copilot-instructions.md" ]; then
            CURRENT_VERSION=$(grep "^\*\*Version:\*\*" .github/copilot-instructions.md | sed 's/\*\*Version:\*\* //' | tr -d '\r')
            echo "📋 Current version: $CURRENT_VERSION"
            echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          else
            echo "❌ No copilot-instructions.md found - setup required"
            echo "current_version=not_found" >> $GITHUB_OUTPUT
            echo "status=setup_required" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Get latest version from centralized metadata
          echo "🌐 Fetching latest version from centralized metadata..."
          LATEST_VERSION=$(curl -s https://raw.githubusercontent.com/DrozmotiX/ioBroker-Copilot-Instructions/main/config/metadata.json | jq -r '.template.version')
          echo "🆕 Latest version: $LATEST_VERSION"
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          
          # Compare versions
          if [ "$CURRENT_VERSION" = "$LATEST_VERSION" ]; then
            echo "✅ Template is up to date (version $CURRENT_VERSION)"
            echo "status=up_to_date" >> $GITHUB_OUTPUT
          else
            echo "⚠️  Update available: $CURRENT_VERSION → $LATEST_VERSION"
            echo "status=update_available" >> $GITHUB_OUTPUT
          fi
          
          # Get repository information
          REPO_NAME=$(basename $GITHUB_REPOSITORY)
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
          
      - name: Check for existing issues
        id: check-issues
        if: steps.version-check.outputs.status == 'update_available'
        run: |
          echo "🔍 Checking for existing template update issues..."
          
          # Search for existing open issues with template-update label
          EXISTING_ISSUES=$(gh issue list --label "template-update" --state "open" --json number,title --jq '. | length')
          
          if [ "$EXISTING_ISSUES" -gt 0 ]; then
            echo "ℹ️  Found $EXISTING_ISSUES existing template update issue(s)"
            echo "create_issue=false" >> $GITHUB_OUTPUT
          else
            echo "✨ No existing template update issues found - will create new issue"
            echo "create_issue=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create update issue
        if: steps.version-check.outputs.status == 'update_available' && steps.check-issues.outputs.create_issue == 'true'
        run: |
          echo "📝 Creating GitHub issue for template update..."
          
          # Create the issue body with update instructions
          cat > issue_body.md << 'EOF'
          ## 🔄 ioBroker Copilot Template Update Available
          
          **GitHub Copilot**: Please help update the GitHub Copilot instructions to the latest template version.
          
          ### Version Information
          - **Current Version**: ${{ steps.version-check.outputs.current_version }}
          - **Latest Version**: ${{ steps.version-check.outputs.latest_version }}
          - **Repository**: ${{ steps.version-check.outputs.repo_name }}
          
          ### Update Instructions for GitHub Copilot
          
          **GitHub Copilot**: Please perform the following update process:
          
          #### 1. Backup Current Customizations
          - [ ] Identify all `[CUSTOMIZE]` sections in `.github/copilot-instructions.md`
          - [ ] Extract and preserve any custom content that differs from the standard template
          - [ ] Note any repository-specific modifications
          
          #### 2. Download and Apply Latest Template
          - [ ] Fetch the latest template from: https://raw.githubusercontent.com/DrozmotiX/ioBroker-Copilot-Instructions/main/template.md
          - [ ] Remove the template comment block (lines between `<!--` and `-->` at the top)
          - [ ] Update the version number to `${{ steps.version-check.outputs.latest_version }}`
          - [ ] Preserve the template source reference
          
          #### 3. Restore Customizations
          - [ ] Re-integrate all preserved custom content into appropriate `[CUSTOMIZE]` sections
          - [ ] Ensure custom content is unique and doesn't duplicate standard template content
          - [ ] Maintain adapter-specific context and requirements
          
          #### 4. Validation
          - [ ] Verify the file structure is correct
          - [ ] Confirm version number matches `${{ steps.version-check.outputs.latest_version }}`
          - [ ] Test GitHub Copilot functionality with updated instructions
          - [ ] Ensure no duplicate content between custom and standard sections
          
          ### Automated Detection Details
          - **Detection Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **Workflow Run**: ${{ github.run_id }}
          - **Template Source**: https://github.com/DrozmotiX/ioBroker-Copilot-Instructions
          - **Metadata Source**: https://raw.githubusercontent.com/DrozmotiX/ioBroker-Copilot-Instructions/main/config/metadata.json
          
          ### Benefits of This Update
          - 🆕 Latest ioBroker adapter development patterns
          - 🛡️ Improved security recommendations  
          - ⚡ Performance optimizations
          - 📚 Enhanced documentation standards
          - 🧪 Updated testing practices
          
          ---
          
          **Note**: This issue was automatically created by the ioBroker Copilot template monitoring system. The template is checked weekly to ensure your repository benefits from the latest improvements and best practices.
          EOF
          
          # Create the issue
          gh issue create \
            --title "🤖 Update ioBroker Copilot Template to v${{ steps.version-check.outputs.latest_version }}" \
            --body-file issue_body.md \
            --label "template-update,automation" \
            --assignee "copilot"
          
          echo "✅ Created issue for template update"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create setup issue  
        if: steps.version-check.outputs.status == 'setup_required'
        run: |
          echo "📝 Creating GitHub issue for initial setup..."
          
          # Check if setup issue already exists
          EXISTING_SETUP_ISSUES=$(gh issue list --label "copilot-setup" --state "open" --json number --jq '. | length')
          
          if [ "$EXISTING_SETUP_ISSUES" -gt 0 ]; then
            echo "ℹ️  Setup issue already exists - skipping creation"
            exit 0
          fi
          
          # Create the issue body for initial setup
          cat > setup_issue_body.md << 'EOF'
          ## 🚀 Initial ioBroker Copilot Instructions Setup Required
          
          **GitHub Copilot**: Please help set up GitHub Copilot instructions for this ioBroker adapter repository.
          
          ### Repository Information
          - **Repository**: ${{ steps.version-check.outputs.repo_name }}
          - **Status**: No copilot instructions found
          - **Target Version**: ${{ steps.version-check.outputs.latest_version }}
          
          ### Setup Instructions for GitHub Copilot
          
          **GitHub Copilot**: Please perform the initial setup:
          
          #### 1. Repository Analysis
          - [ ] Confirm this is an ioBroker adapter repository
          - [ ] Identify adapter name and functionality from `package.json` and `io-package.json`
          - [ ] Analyze dependencies and external integrations
          - [ ] Review README.md for adapter-specific requirements
          
          #### 2. Template Setup
          - [ ] Download template from: https://raw.githubusercontent.com/DrozmotiX/ioBroker-Copilot-Instructions/main/template.md
          - [ ] Remove template comment block (lines between `<!--` and `-->`)
          - [ ] Create `.github/copilot-instructions.md` with the cleaned template
          - [ ] Update version to `${{ steps.version-check.outputs.latest_version }}`
          
          #### 3. Customization
          - [ ] Fill in `[CUSTOMIZE]` sections with adapter-specific information:
            - Adapter purpose and functionality
            - Key dependencies and external services
            - Unique architectural considerations
            - Specific testing requirements
            - Configuration patterns
          
          #### 4. Validation
          - [ ] Verify file is created at `.github/copilot-instructions.md`
          - [ ] Confirm version number is correct
          - [ ] Test GitHub Copilot integration
          - [ ] Ensure all customizations are complete
          
          ### Template Information
          - **Latest Version**: ${{ steps.version-check.outputs.latest_version }}
          - **Template Source**: https://github.com/DrozmotiX/ioBroker-Copilot-Instructions
          - **Detection Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          ---
          
          **Note**: This issue was automatically created by the template monitoring system. Once setup is complete, weekly checks will ensure the template stays up to date.
          EOF
          
          # Create the setup issue
          gh issue create \
            --title "🚀 Setup ioBroker Copilot Instructions (Initial Setup Required)" \
            --body-file setup_issue_body.md \
            --label "copilot-setup,automation" \
            --assignee "copilot"
          
          echo "✅ Created issue for initial setup"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          echo "📊 Template Version Check Summary"
          echo "=================================="
          echo "Repository: ${{ steps.version-check.outputs.repo_name }}"
          echo "Current Version: ${{ steps.version-check.outputs.current_version }}"
          echo "Latest Version: ${{ steps.version-check.outputs.latest_version }}"
          echo "Status: ${{ steps.version-check.outputs.status }}"
          echo "=================================="
          
          case "${{ steps.version-check.outputs.status }}" in
            "up_to_date")
              echo "✅ Template is current - no action required"
              ;;
            "update_available")
              echo "⚠️  Update available - issue created for GitHub Copilot"
              ;;
            "setup_required")
              echo "🚀 Initial setup required - issue created for GitHub Copilot"
              ;;
            *)
              echo "❓ Unknown status - please check workflow logs"
              ;;
          esac